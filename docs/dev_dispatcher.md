# 设备调度服务

本文档描述了开放视频平台对外提供的设备调度服务，及相应流程。

## 1 名词解释

- OVC：Open Video Cloud，运行在云端的开放视频云平台，其包含各种类型的子服务、通信协议及API接口，支持多形态开放视频设备（OVD）的接入管理，实时媒体流推送、录像切片上传及其它功能。

- OVD：Open Video Device, 开放视频设备，安装在客户现场的，具有与OVC通信能力的视频设备，如摄像头，门铃，音箱等，OVD通过“开放协议”接入OVC，并接受OVC的管理。

- OVP：Open Video disPatcher 开放视频设备调度服务，是OVC提供的一项设备调度子服务，用于将OVD设备分配到不同机房的服务上。设备通过该服务获得其余服务的通信地址，进一步访问OVC其余各类服务。

## 2 服务描述

设备调度服务的主要目标是根据特定的调度策略将全网的OVD设备接入到不同地域的机房中，实现全国范围内的负载分担。服务提供标准的HTTP接口，根据提供的设备ID，返回相应机房各项服务的连接地址信息。

### 2.1 请求应答流程

设备向设备服务调度服务器发送http请求 method为get
设备服务器回复报文格式为：
{
	"PassDomain": "hy-dj-as.worthcloud.net",                      //信令服务器地址
	"P2p_passDomain": "hy-dj-jckd.worthcloud.net",                //p2p服务器地址
	"TurnDomain": "hy-dj-turn.worthcloud.net",                    //turn服务器地址
	"HibernationDomain": "www.test04.com",                        //休眠服务器地址
	"PassPort": 9080,                                             //信令服务器ws接口(非加密接口)
	"Secure_PassPort": 0,                                         //信令服务器wss接口(若设备支持wss协议,且下发非0值，设备则开启wss连接)
	"P2p_passPort": 4755,                                         //p2p接口
	"TurnPort": 3478,                                             //turn服务器端口
	"HibernationPort": 13,                                        //休眠服务器接口
	"HibernationHBInterval": 14,                                  //休眠服务心跳间隔(单位为秒)
	"MaxP2PSession": 15,                                          //最大p2p会话
	"SyncTime": 1000000                                           //服务器当前时间(单位为微秒)
}


注：
    a. 当设备不支持wss协议时，设备采用ws协议连接信令服务器, 当设备支持wss协议，且下发应答中"Secure_PassPort"值非0时，设备采用wss协议
	b. 设备会根据服务器下发的"SyncTime"值来同步设备本地时间，同步的规则为：若下发值跟设备当前本地时间相差10s以上，则设置，否则不设置。

### 2.2 服务调度规避算法

在某些情况下，由于网络异常等原因可能会导致跟设备调度服务器通信失败，需要设备端进行重连尝试，为了防止某一时刻大量设备访问调度服务器，故设备重连需要进行重连时间规避。
当前重连时间规避算法为：
N:重试次数
N<=12 时， 设备随机休眠 0~N*5s  后重试
N>12时， 设备随机休眠 60s 后重试

### 2.3 服务调度请求发生时机

a.在设备sdk刚启动时，设备sdk会进行服务调度请求, 此时服务调度流程是同步过程，即服务调度不成功，设备sdk就不能正常的工作运作
b.设备sdk正常运作后，因网络异常或信令服务器异常，导致设备与信令服务器不停重连，当设备多次重连信令服务器失败（失败次数超过15次),则设备重新发起服务调度请求，此时服务调度流程应该是异步的，即不影响其他工作线程。
c.设备sdk正常运作后，信令服务器下发"reschedule"指令,设备会进行发起服务调度请求，此时服务调度流程是异步的，在服务调度流程成功前，其他工作线程正常工作，等服务调度流程成功后，各服务器连接线程重启。





