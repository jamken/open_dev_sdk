开放平台设备休眠协议
======================

本文档描述了 `开放平台 <http://>`_ 与本地视频设备之间的休眠通信，
通过本协议，设备在休眠状态下仍然能够与平台保持通信

1 名词解释
^^^^^^^^^^^^^

- OVS：open video system，开放视频云，一种基于物联网云计算技术的视频云系统；
  与传统NVR，DVR类似，OVS可以接入和管理各种带视频功能设备，支持直播、录像、点播、P2P实时通信等功能，
  但是与传统NVR，DVR的不同在于用户可以在互联网上观看视频，
  并且因为应用了云计算技术，OVS拥有近于无限的接入能力以及海量的并发直播点播请求；OVS主要由OVC与OVD两部分组成。

- OVC：open video cloud，运行在云端的开放视频云平台；
  提供API接口以及管理网页，用户可以随时通过互联网，以网页、APP、公众号、小程序等方式接入OVC，对其下属的摄像头进行管理，并进行直播点播。

- OVD：open video device, 开放视频设备，安装在客户现场的，具有与OVC通信能力的视频设备，如摄像头，门铃，音箱等，OVD通过“开放协议”接入OVC，并接受OVC的管理。

- OVS Hibernation：OVD与OVC之间采用的休眠通信协议

2 协议特性
^^^^^^^^^^^^

OVS Hibernation的设计目标是尽可能简单，能够兼容大部分设备休眠模块的处理逻辑。协议直接基于**TCP/IP**之上，在TCP长连接上收发固定格式的报文即可实现。


2.1 接入流程
++++++++++++++++


1. OVD在没活动的情况下自动关闭主芯片电路，并启动网络接口（卡/板）的休眠功能。

2. 网络接口（卡/板）与OVC的休眠服务IP地址/端口建立TCP长连接。

3. 网络接口（卡/板）每10秒向OVC休眠服务发送一个心跳报文。

4. 若收到OVC发出的唤醒报文，则停止网络接口（卡/板）的休眠功能，启动主芯片电路，正常接入OVC。

2.2 异常处理
+++++++++++++++++

在某些原因下，网络原因可能会被中间设备中断。OVD应该在检测到TCP长连接断开后，能够在一定的随机事件内重新与OVC建立连接，继续发送心跳报文。
TCP连接中断，OVC并不认为是OVD离线，只有在一定周期（30S）内没有收到相关心跳报文，才会对OVD做离线处理。


3 应用层协议数据包格式
^^^^^^^^^^^^^^^^^^^^^^^^^^

此处数据包指的是直接基于TCP之上传输的数据包，数据包的格式为二进制格式，字节顺序为 **大端**

3.1 心跳上报
+++++++++++++++

OVD应该按照一定的时间周期（10秒），在TCP长连接上，向OVC发送下述结构的数据包。

方向： ::

  OVD -> OVC


包格式:  ::

  typedef struct
  {
      char magic[2];         // 同步字段，固定为0xcc, 0x00
      uint16_t length;       // 长度，固定为18，大端
      char macid[16];        // 设备id，16位十进制数字字符串，例如"2009550000011079"
      uint16_t cmd;       // 命令字, 固定位0x4A。
  }CmdPacket;



3.2 唤醒
++++++++++++

当OVC需要唤醒OVD时，在TCP连接上向OVD发送下述结构的数据包。

方向:    ::

  OVC -> OVD
  
  
包格式:   ::

  typedef struct{
      char cmd[8];         // 字符串，固定为"TOWAKEUP"
  }CmdAwake；

